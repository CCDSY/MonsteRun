var LoadingUI=function(e){function t(){e.call(this),this.createView()}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},s.setProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.onAddToStage=function(e){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(e){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(e){"preload"==e.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.main())},s.onItemLoadError=function(e){console.warn("Url:"+e.resItem.url+" has failed to load")},s.onResourceLoadError=function(e){console.warn("Group:"+e.groupName+" has failed to load"),this.onResourceLoadComplete(e)},s.onResourceProgress=function(e){"preload"==e.groupName&&this.loadingView.setProgress(e.itemsLoaded,e.itemsTotal)},s.main=function(){this.addChild(new GameScene),this.addChild(new WelcomeScene)},t}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var Movement;!function(e){e[e.Up=0]="Up",e[e.Right=1]="Right",e[e.Left=2]="Left",e[e.Still=3]="Still"}(Movement||(Movement={}));var GameLifeCycleEvent=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t);i.prototype;return t.GAME_STARTED="GAME_STARTED",t.GAME_ENDED="GAME_ENDED",t}(egret.Event);egret.registerClass(GameLifeCycleEvent,"GameLifeCycleEvent");var GameObjectEvent=function(e){function t(){e.apply(this,arguments)}__extends(t,e);var i=(__define,t);i.prototype;return t.OBJECT_DESTROYED="OBJECT_DESTROYED",t}(egret.Event);egret.registerClass(GameObjectEvent,"GameObjectEvent");var Background=function(e){function t(t,i,s){e.call(this),this.skyMovementSpeed=t,this.floorMovementSpeed=i,this.floorHeight=s,this.once(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this),GameScene.getInstance().once(GameLifeCycleEvent.GAME_STARTED,this.startMoving,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.onAddToStage=function(){var e=Utility.createBitmapByName("background_png"),t=Utility.createBitmapByName("background_png");this.sky=new Stack([e,t],-2),this.sky.width=this.width<<1,this.sky.height=this.height-this.floorHeight,this.addChild(this.sky),this.floor=Utility.createBitmapByName("block_png"),this.floor.width=this.width<<1,this.floor.height=this.floorHeight,this.floor.fillMode=egret.BitmapFillMode.REPEAT,this.floor.y=this.height-this.floorHeight,this.addChild(this.floor)},s.startMoving=function(){this.animateSky(),this.animateFloor()},s.animateFloor=function(){var e=this.width/this.floorMovementSpeed;egret.Tween.get(this.floor).to({x:-this.width},e).call(this.resetFloor,this)},s.animateSky=function(){var e=this.width/this.skyMovementSpeed;egret.Tween.get(this.sky).to({x:-this.width},e).call(this.resetSky,this)},s.resetSky=function(){this.sky.x=0,this.animateSky()},s.resetFloor=function(){this.floor.x=0,this.animateFloor()},t}(egret.DisplayObjectContainer);egret.registerClass(Background,"Background");var Obstacle=function(e){function t(t,i,s,n,o){e.call(this),this.collisionTestOffsetThreshold=250,this.player=Player.getInstance(),this.scored=!1,this.activated=!1,this.activationDuration=t,this.activationPosition=i,this.activationDistance=s,this.activationMovement=n,this.movementSpeed=o,this.game=GameScene.getInstance();var a=RES.getRes("monster_01_png");this.texture=a,this.addEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),GameScene.getInstance().once(GameLifeCycleEvent.GAME_ENDED,this.destroy,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.onEnterFrame=function(e){this.scored||(this.x<=this.activationPosition&&!this.activated&&this.activate(),this.x<=this.player.x+this.collisionTestOffsetThreshold&&Utility.testCollision(this,this.player)&&this.player.die(),this.x+(this.width>>1)<=this.player.x-(this.player.width>>1)&&(this.game.incrementScores(),this.scored=!0))},s.activate=function(){if(this.activated=!0,this.activationMovement!=Movement.Still){var e,t=this.movementSpeed*this.activationDuration/1e3;this.activationMovement==Movement.Up?e={y:this.y-this.activationDistance,x:this.x-t}:this.activationMovement==Movement.Left?e={x:this.x-this.activationDistance-t}:this.activationMovement==Movement.Right&&(e={x:this.x+this.activationDistance-t}),egret.Tween.removeTweens(this),egret.Tween.get(this).to(e,this.activationDuration).call(this.startMoving)}},s.startMoving=function(){var e={x:-this.width},t=(this.x-e.x)/this.movementSpeed*1e3;egret.Tween.get(this).to(e,t).call(this.destroy)},s.destroy=function(){this.removeEventListener(egret.Event.ENTER_FRAME,this.onEnterFrame,this),this.dispatchEvent(new GameObjectEvent(GameObjectEvent.OBJECT_DESTROYED))},t}(egret.Bitmap);egret.registerClass(Obstacle,"Obstacle");var Player=function(e){function t(i,s){e.call(this),this.landed=!0,this.jumpHeight=i,this.jumpTime=s;var n=RES.getRes("player_png");this.texture=n,t.instance=this,GameScene.getInstance().once(GameLifeCycleEvent.GAME_STARTED,this.start,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return t.getInstance=function(){return t.instance},s.start=function(){var e=GameScene.getInstance();e.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.jump,this),e.touchEnabled=!0},s.jump=function(){if(this.landed){var e=this,t=this.y,i=function(){e.landed=!0},s=function(){egret.Tween.get(e).to({y:t},e.jumpTime,egret.Ease.quadIn).call(i)};this.landed=!1,egret.Tween.get(e).to({y:t-e.jumpHeight},e.jumpTime,egret.Ease.quadOut).call(s)}},s.die=function(){var e=GameScene.getInstance();e.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.jump,this),e.endGame(),this.playerDeathAnimation()},s.playerDeathAnimation=function(){var e=this,t=this.y,i=function(){if(e&&e.stage){var t={y:e.stage.stageHeight+e.height},i=e.jumpHeight/e.jumpTime,s=t.y-e.y,n=s/i;egret.Tween.get(e).to(t,n,egret.Ease.quadIn)}};egret.Tween.get(e).to({y:t-e.jumpHeight},e.jumpTime,egret.Ease.quadOut).call(i)},t}(egret.Bitmap);egret.registerClass(Player,"Player");var Stack=function(e){function t(t,i){e.call(this),this.offset=0,this.contents=t,this.offset=i,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.onAddToStage=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this);for(var e=this.width/this.contents.length,t=0;t<this.contents.length;t++)this.contents[t].width=e,this.contents[t].height=this.height,this.contents[t].x=t*e+this.offset,this.addChild(this.contents[t])},t}(egret.DisplayObjectContainer);egret.registerClass(Stack,"Stack");var GameScene=function(e){function t(){e.call(this),this.scores=0,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.createGameScene,this),t.instance=this}__extends(t,e);var i=(__define,t),s=i.prototype;return t.getInstance=function(){return t.instance},s.createGameScene=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.createGameScene,this);var e=this.stage.stageWidth,t=this.stage.stageHeight,i=RES.getRes("background_config_json");this.background=new Background(i.skyMovementSpeed,i.floorMovementSpeed,i.floorHeight),this.background.width=e,this.background.height=t,this.addChild(this.background);var s=RES.getRes("player_config_json");this.player=new Player(s.jumpHeight,s.jumpTime),this.player.width=s.size.width,this.player.height=s.size.height,this.player.x=s.initialPosition.x,this.player.y=t-s.initialPosition.offsetY,this.player.anchorOffsetX=this.player.width>>1,this.player.anchorOffsetY=this.player.height>>1,this.addChild(this.player);var n=RES.getRes("obstacle_factory_config_json");this.factory=new ObstacleFactory(n,[this.player.x,this.player.y]);var o=RES.getRes("score_label_config_json");this.scoreTextPrefix=o.prefix,this.scoreLabel=new egret.TextField,this.scoreLabel.x=o.leftMargin,this.scoreLabel.y=o.topMargin,this.scoreLabel.size=o.fontSize,this.addChild(this.scoreLabel),this.scoreLabel.textColor=0},s.startGame=function(){this.updateScoreText(),this.dispatchEvent(new GameLifeCycleEvent(GameLifeCycleEvent.GAME_STARTED))},s.endGame=function(){this.dispatchEvent(new GameLifeCycleEvent(GameLifeCycleEvent.GAME_ENDED)),egret.Tween.removeAllTweens(),this.showScores()},s.incrementScores=function(){this.scores++,this.updateScoreText()},s.updateScoreText=function(){this.scoreLabel.text=this.scoreTextPrefix+this.scores},s.showScores=function(){this.removeChild(this.scoreLabel),this.parent.addChild(new ScoresScene(this.scores))},t}(egret.DisplayObjectContainer);egret.registerClass(GameScene,"GameScene");var ScoresScene=function(e){function t(t){e.call(this),this.scores=t,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.createScene,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createScene=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.createScene,this);var e=(this.stage.stageWidth,this.stage.stageHeight,new egret.TextField);this.addChild(e),Utility.configureCenteredTextField(e,108,String(this.scores),-100),e.textColor=16711680;for(var t,i=RES.getRes("remark_config_json"),s=0;s<i.length;s++)if(this.scores<i[s].threshold){t=i[s].remark;break}t||(t="Not bad…");var n=new egret.TextField;this.addChild(n),Utility.configureCenteredTextField(n,32,t,0),n.textColor=0;var o=new egret.TextField;this.addChild(o),Utility.configureCenteredTextField(o,64,"Try Again",100),o.textColor=2341667,o.once(egret.TouchEvent.TOUCH_TAP,this.retry,this),o.touchEnabled=!0},s.retry=function(){var e=this.parent;e.removeChildren();var t=new GameScene;e.addChild(t),t.startGame()},t}(egret.DisplayObjectContainer);egret.registerClass(ScoresScene,"ScoresScene");var WelcomeScene=function(e){function t(){e.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.createScene,this)}__extends(t,e);var i=(__define,t),s=i.prototype;return s.createScene=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.createScene,this);var e=(this.stage.stageWidth,this.stage.stageHeight,new egret.TextField);this.addChild(e),Utility.configureCenteredTextField(e,92,"MonsteRun",-100),e.textColor=877723;var t=new egret.TextField;this.addChild(t),Utility.configureCenteredTextField(t,48,"GO!",100),t.textColor=2341667,t.once(egret.TouchEvent.TOUCH_TAP,this.startGame,this),t.touchEnabled=!0},s.startGame=function(){var e=this.parent;e.removeChild(this),GameScene.getInstance().startGame()},t}(egret.DisplayObjectContainer);egret.registerClass(WelcomeScene,"WelcomeScene");var ObstacleFactory=function(){function e(e,t){this.obstacles=[],this.ended=!1,this.baseSpawnDelay=e.baseSpawnDelay,this.spawnDelayRandomizationRange=e.spawnDelayRandomizationRange,this.movePossibility=e.startingMovePossibility,this.movePossibilityIncrement=e.stepMovePossibility,this.maxMovePossibility=e.maxMovePossibility,this.safeCounter=e.movePossibilityIncrementStartDelay,this.obstacleConfig=e.obstacleConfig,this.playerInitialPosition=t,this.container=GameScene.getInstance();var i=GameScene.getInstance();i.once(GameLifeCycleEvent.GAME_STARTED,this.startSpawning,this),i.once(GameLifeCycleEvent.GAME_ENDED,this.stopSpawning,this)}var t=(__define,e),i=t.prototype;return i.getObstacles=function(){return this.obstacles},i.startSpawning=function(){this.timer||(this.timer=new egret.Timer(this.createSpawnDelay(),1),this.timer.addEventListener(egret.TimerEvent.TIMER_COMPLETE,this.onTimerComplete,this),this.ended=!1),this.timer.start()},i.stopSpawning=function(){this.timer.stop(),this.ended=!0},i.createSpawnDelay=function(){var e=Math.round(Math.random()*this.spawnDelayRandomizationRange*2-this.spawnDelayRandomizationRange);return this.baseSpawnDelay+e},i.onTimerComplete=function(){this.spawn(),this.timer.delay=this.createSpawnDelay(),this.timer.start()},i.spawn=function(){var e=new Obstacle(this.obstacleConfig.activationDuration,this.playerInitialPosition[0]+this.obstacleConfig.activationOffset,this.obstacleConfig.activationDistance,this.chooseMovement(),this.obstacleConfig.movementSpeed);e.width=this.obstacleConfig.size.width,e.height=this.obstacleConfig.size.height,e.x=this.container.stage.stageWidth+(e.width>>1),e.y=this.playerInitialPosition[1],e.anchorOffsetX=e.width>>1,e.anchorOffsetY=e.height>>1,this.container.addChild(e),this.obstacles.push(e),this.safeCounter>0?this.safeCounter--:this.movePossibility<this.maxMovePossibility&&(this.movePossibility+=this.movePossibilityIncrement,this.movePossibility>this.maxMovePossibility&&(this.movePossibility=this.maxMovePossibility));var t=this,i=function(){t.ended||(t.obstacles.shift(),e.parent.removeChild(e))};e.addEventListener(GameObjectEvent.OBJECT_DESTROYED,i,this),e.startMoving()},i.chooseMovement=function(){return Math.random()<this.movePossibility?Math.floor(3*Math.random()):Movement.Still},e}();egret.registerClass(ObstacleFactory,"ObstacleFactory");var Utility=function(){function e(){}var t=(__define,e);t.prototype;return e.createBitmapByName=function(e){var t=new egret.Bitmap,i=RES.getRes(e);return t.texture=i,t},e.testCollision=function(e,t){return e.getTransformedBounds(e.parent).intersects(t.getTransformedBounds(t.parent))},e.configureCenteredTextField=function(e,t,i,s){e.size=t,e.text=i,e.x=e.stage.stageWidth>>1,e.y=(e.stage.stageHeight>>1)+s,e.anchorOffsetX=e.width>>1,e.anchorOffsetY=e.height>>1},e}();egret.registerClass(Utility,"Utility");